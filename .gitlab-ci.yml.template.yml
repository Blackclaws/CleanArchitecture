image: mcr.microsoft.com/dotnet/sdk:5.0

stages:
  - generate
  - build
  - test
  - push

generateDependencies:
  stage:
    generate
  image:
    # TODO Change to image of choice, for security reasons an in-house version of this image is always recommended 
    openapitools/openapi-generator-cli
  script:
    ./generateOpenAPIAllCI.sh
  artifacts:
    paths:
      - /src/Clean.Architecture.API.Client/
      - /src/Clean.Architecture.API.Server.Base/

build:
  stage:
    build
  needs: 
    - generateDependencies
  script:
    - dotnet build -c Release
  artifacts:
    paths:
      - "**/bin/"
      - "**/obj/"

test:
  stage:
    test
  needs:
    - generateDependencies
    - build
  script:
    - dotnet test -c Release

push:
  needs:
    - generateDependencies
    - build
    - test
  stage: push
  script:
    - dotnet pack -c Release -o "Packages"
    - dotnet nuget add source "$CI_SERVER_URL/api/v4/projects/$CI_PROJECT_ID/packages/nuget/index.json" --name gitlab --username gitlab-ci-token --password $CI_JOB_TOKEN --store-password-in-clear-text
    - dotnet nuget push "Packages/*.nupkg" --source gitlab
